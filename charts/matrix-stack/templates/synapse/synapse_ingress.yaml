{{- /*
Copyright 2024 New Vector Ltd

SPDX-License-Identifier: AGPL-3.0-only OR LicenseRef-Element-Commercial
*/ -}}

{{- with .Values.synapse -}}
{{- if .enabled -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
{{- include "element-io.ess-library.ingress.annotations" (dict "root" $ "context" .ingress.annotations) | nindent 2 }}
  labels:
    {{- include "element-io.synapse.labels" (dict "root" $ "context" .haproxy) | nindent 4 }}
  name: {{ $.Release.Name }}-synapse
  namespace: {{ $.Release.Namespace }}
spec:
{{- include "element-io.ess-library.ingress.tlsSecret" (dict "root" $ "context" (dict "hosts" (list (required "synapse.ingress.host is required" .ingress.host)) "tlsSecret" .ingress.tlsSecret)) | nindent 2 }}
{{- include "element-io.ess-library.ingress.className" (dict "root" $ "context" .ingress.className) | nindent 2 }}
  rules:
  - host: {{ (tpl .ingress.host $) | quote }}
    http:
      paths:
{{- range .ingress.additionalPaths -}}
{{- if eq .availability "only_externally" }}
      - path: {{ .path }}
        pathType: Prefix
        backend:
          service:
            name: {{ (tpl .service.name $) | quote }}
            port:
              {{ .service.port | toYaml }}
{{- else if eq .availability "blocked" }}
      - path: {{ .path }}
        pathType: Prefix
        backend:
          service:
            name: "{{ $.Release.Name }}-haproxy"
            port:
              name: haproxy-403
{{- end }}
{{- end }}
{{- range $synapsePath := (list "/_matrix" "/_synapse") -}}
{{- /* Determine if this path is equal to, or a subset of, one of the
   defined additional paths. If so, let the other service handle it and don't
   add it here. */}}
{{- $_pathAlreadyDefined := false }}
{{- range $.Values.synapse.ingress.additionalPaths -}}
{{- if has .availability (list "only_externally" "blocked") }}
{{- if hasPrefix .path $synapsePath }}
{{- $_pathAlreadyDefined = true }}
{{- end }}
{{- end }}
{{- end -}}
{{- /* The path, or a superset of, has not already been defined in _additional_paths.
   Define it here.*/}}
{{- if not $_pathAlreadyDefined }}
      - path: {{ $synapsePath }}
        pathType: Prefix
        backend:
          service:
            name: "{{ $.Release.Name }}-haproxy"
            port:
              name: haproxy-http
{{- end }}
{{- end }}
{{- end -}}
{{- end -}}
